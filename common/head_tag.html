<!-- SYSTEM JAVASCRIPT - DO NOT EDIT -->
<script type="text/javascript" nonce="{{nonce}}">
    // This is the component that will be rendered in the post menu
	class DownloadFormComponent extends Component {
	  @service router;
	  @tracked formLoaded = false;
	  @tracked marketoFormId = null;
	  @tracked isBelongsToBannedCountry = false;
	  @tracked isBelongsToDownloadsGroup = false;
	  @tracked isBelongsToBannedEmailDomain = false;
	  @tracked currentuserEmail = "";
	  @tracked currentuserFirstName = "";
	  @tracked currentuserLastName = "";
	  @tracked currentuserJob = "";
	  @tracked currentuserCountry = "";
	  @tracked currentuserCompany = "";
	  @tracked currentuserState = "";
	  @tracked currentuserProvince = "";
	
	  constructor() {
	    super(...arguments);
	    this.determineMarketoFormId();
	    this.loadRequiredScripts();
	    this.getCurrentUserData();
	  }
	
	  determineMarketoFormId() {
	    const path = window.location.pathname;
	    
	    if(/^\/t\/webmethods-free-trial-download\//.test(path)) {
	      this.marketoFormId = "mktoForm_12281";
	    } 
	    else if(/^\/t\/adabas-and-natural-community-edition-download-form\//.test(path)) {
	      this.marketoFormId = "mktoForm_12282";
	    }
	    else if(/^\/t\/webmethods-service-designer-download-form\//.test(path)) {
	      this.marketoFormId = "mktoForm_8655";
	    }
	    else if(/^\/t\/webmethods-io-connector-builder-download-form\//.test(path)) {
	      this.marketoFormId = "mktoForm_12313";
	    }
	    else if(/^\/t\/webmethods-service-designer-11-1-download-form\//.test(path)) {
	      this.marketoFormId = "mktoForm_16841";
	    }
	  }
	
	  loadRequiredScripts() {
	    const forms2MinJsUrl = "https://info.softwareag.com/js/forms2/js/forms2.min.js";
	    const munchkinJsUrl = "https://munchkin.marketo.net/munchkin.js";
	    const mktFormSupportJsUrl = "https://info.softwareag.com/js/mktFormSupport.js";
	    
	    let forms2MinJs = document.querySelector('head script[src="' + forms2MinJsUrl + '"]');
	    
	    if(!forms2MinJs) {
	      forms2MinJs = document.createElement("script");
	      let munchkinJs = document.createElement("script");
	      let mktFormSupportJs = document.createElement("script");
	
	      forms2MinJs.src = forms2MinJsUrl;	
	      forms2MinJs.setAttribute("nonce", "");
	      document.head.appendChild(forms2MinJs);
	
	      munchkinJs.src = munchkinJsUrl;
	      munchkinJs.setAttribute("nonce", "");
	      document.head.appendChild(munchkinJs);
	
	      mktFormSupportJs.src = mktFormSupportJsUrl;
	      mktFormSupportJs.setAttribute("nonce", "");
	      document.head.appendChild(mktFormSupportJs);
	    }
	
	    this.forms2MinJs = forms2MinJs;
	  }
	
	  @action
	  loadMarketoForm() {
	    if (!this.marketoFormId) return;
	    
	    const autofillDownloadFormFields = () => {
	      let state_province = "";
	      //Set the State/Province based on selected Country.
	      if(this.currentuserCountry && this.currentuserCountry.toUpperCase() == 'USA') {
	        state_province = this.currentuserState;
	      } else if(this.currentuserCountry && this.currentuserCountry.toUpperCase() == 'CANADA') {
	        state_province = this.currentuserProvince;
	      }
	      
	      let firstNameInput = document.querySelector('input#FirstName')
	      if(firstNameInput) {
	        firstNameInput.value = this.currentuserFirstName;
	      }
	      let lastNameInput = document.querySelector('input#LastName');
	      if(lastNameInput) {
	        lastNameInput.value = this.currentuserLastName
	      }
	      let emailInput = document.querySelector('input#Email');
	      if(emailInput) {
	        emailInput.value = this.currentuserEmail;
	      }
	      let countryInput = document.querySelector('select#Address_Visit_Country__c');
	      if(countryInput) {
	        countryInput.value = this.currentuserCountry;
	        countryInput.dispatchEvent(new Event('change'));
	      }
	      let StateProvinceInput = document.querySelector('select#Address_Visit_State__c');
	      if(StateProvinceInput){
	        StateProvinceInput.value = state_province;
	      }
	      let companyInput = document.querySelector('input#Company');
	      if(companyInput) {
	        companyInput.value = this.currentuserCompany;
	      }
	      let jobTitleInput = document.querySelector('input#Title');
	      if(jobTitleInput) {
	        jobTitleInput.value = this.currentuserJob;
	      }
	    }
	
	    if(!document.querySelector(`form#${this.marketoFormId}`)) {
	      if(!window.MktoForms2) {
	        this.forms2MinJs.onload = () => {
	          MktoForms2.loadForm("//info.softwareag.com", "858-DJP-749", this.marketoFormId.replace("mktoForm_", ""), autofillDownloadFormFields);  
	          this.removeFormSpinner();
	          this.formLoaded = true;
	        };
	      } else {
	        MktoForms2.loadForm("//info.softwareag.com", "858-DJP-749", this.marketoFormId.replace("mktoForm_", ""), autofillDownloadFormFields);  
	        this.removeFormSpinner();
	        this.formLoaded = true;
	      }
	    }
	  }
	
	  @action
	  removeFormSpinner() {
	    let spinner = document.querySelector('form.marketo-form .spinner-wrapper');
	    if(spinner){ 
	      document.querySelector('form.marketo-form').removeChild(spinner);
	    }
	  }
	
	  checkNull(value) {
	    if(typeof(value) != "undefined" && value != null && value !='null') {
	      return value;
	    } 
	    return "";
	  }
	
	  @action
	  getCurrentUserData() {
	    // Get current user info
	    const currentuser = this.args.currentUser;
	    if (!currentuser) {
	      DiscourseURL.routeToUrl('/signup');
	      return;
	    }
	
	    const currentusername = currentuser.username;
	    if (!currentusername) {
	      return;
	    }
	
	    const fulllinktojson = `/users/${currentusername}.json`;
	    
	    fetch(fulllinktojson)
	      .then(response => response.json())
	      .then(json => {
	        // List of banned countries
	        let bannedCountries = ["Afghanistan","Algeria","Angola","Armenia","Azerbaijan","Belarus","Birma/Myanmar","Burundi","Cambodia","Central African Republic","China","Congo","Cyprus","Democratic Rep. Of Congo","Egypt","Eritrea","Ethiopia","Georgia","Guinea","Guinea-Bissau","Haiti","Iraq","Israel","Jordan","Kazakhstan","Kyrgyzstan","Laos","Lebanon","Libya","Macau","Mali","Moldova","Mongolia","Mozambique","Myanmar","Nigeria","Pakistan","Russia","Russian federation","Somalia","South Sudan","Sri Lanka","Tajikistan","Tanzania","Tunisia","Turkmenistan","Uganda","Ukraine","Uzbekistan","Venezuela","Vietnam","Yemen","Zimbabwe"];
	        // Banned email domains
	        const bannedEmailDomains = settings.banned_email_domains; 
	
	        // Getting user-fields to fetch user data
	        const userFields = this.args.siteSettings.user_fields;
	        let countryFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("Country").toLowerCase());
	        let stateFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("State").toLowerCase());
	        let provinceFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("Province").toLowerCase());
	        let firstnameFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("First name").toLowerCase());
	        let lastnameFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("Last name").toLowerCase());
	        let companyFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("Company").toLowerCase());
	        let jobTitleFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("Job Title").toLowerCase());
	        
	        // Getting Current Login User Details
	        this.currentuserEmail = String(json.user.email);
	        this.currentuserFirstName = firstnameFieldObj ? this.checkNull(String(json.user.user_fields[firstnameFieldObj.id])) : "";
	        this.currentuserLastName = lastnameFieldObj ? this.checkNull(String(json.user.user_fields[lastnameFieldObj.id])) : "";
	        this.currentuserJob = jobTitleFieldObj ? this.checkNull(String(json.user.user_fields[jobTitleFieldObj.id])) : "";
	        this.currentuserCountry = countryFieldObj ? this.checkNull(String(json.user.user_fields[countryFieldObj.id])) : "";
	        this.currentuserCompany = companyFieldObj ? this.checkNull(String(json.user.user_fields[companyFieldObj.id])) : "";
	        this.currentuserState = stateFieldObj ? this.checkNull(String(json.user.user_fields[stateFieldObj.id])) : "";
	        this.currentuserProvince = provinceFieldObj ? this.checkNull(String(json.user.user_fields[provinceFieldObj.id])) : "";
	        
	        // User Groups
	        let currentuserGroups = [];
	        (json.user.groups).forEach(function (groupObj) {
	          currentuserGroups.push(String(groupObj.name).toLowerCase());
	        });
	        
	        // Check if user belongs to banned country
	        const lowerCaseBannedCountries = bannedCountries.map(value => value.toLowerCase());
	        this.isBelongsToBannedCountry = lowerCaseBannedCountries.indexOf(this.currentuserCountry.toLowerCase()) !== -1;
	
	        // Check if user belongs to banned email domain
	        if (bannedEmailDomains && bannedEmailDomains.length) {
	          const lowerCaseBannedEmailDomains = bannedEmailDomains.split("|").map(value => value.toLowerCase());
	          const currentuserEmailDomain = this.currentuserEmail.substring(this.currentuserEmail.indexOf("@")+1).toLowerCase();
	          this.isBelongsToBannedEmailDomain = lowerCaseBannedEmailDomains.indexOf(currentuserEmailDomain) !== -1;
	        }
	        
	        // Check if user belongs to Downloads group
	        this.isBelongsToDownloadsGroup = currentuserGroups.indexOf(("Downloads").toLowerCase()) !== -1;
	
	        // If user belongs to Banned Country or Banned email domain and not present in Downloads group
	        if((this.isBelongsToBannedCountry || this.isBelongsToBannedEmailDomain) && !this.isBelongsToDownloadsGroup) {
	          DiscourseURL.routeToUrl('/g/Downloads');
	        } else {
	          // Load the form after we have verified the user can access it
	          this.loadMarketoForm();
	        }
	      })
	      .catch(error => {
	        console.error("Error fetching user data:", error);
	      });
	  }
	
	  static template = hbs`
	    {{#if this.marketoFormId}}
	      <div class="d-form">
	        <form 
	          class="marketo-form mktoForm mktoHasWidth mktoLayoutLeft" 
	          method="post" 
	          enctype="application/x-www-form-urlencoded"
	          id={{this.marketoFormId}} 
	          name={{this.marketoFormId}}
	        >
	          {{#unless this.formLoaded}}
	            <div class="spinner-wrapper" style="display:flex; justify-content:center; padding:0.5em">
	              <span class="spinner"></span>
	            </div>
	          {{/unless}}
	        </form>
	      </div>
	    {{/if}}
	  `;
	}
	
	// Plugin initialization
	export default {
	  name: "download-form-plugin",
	  
	  initialize() {
	    withPluginApi("1.34.0", (api) => {
	      // Register the component with Ember
	      api.registerCustomPostMessageCallback("download-form", (controller) => {
	        return {
	          component: DownloadFormComponent
	        };
	      });
	      
	      // Register the value transformer
	      api.registerValueTransformer(
	        "post-menu-buttons",
	        ({ value: dag, context: { post, buttonKeys } }) => {
	          // Only add the download form for first post in specific topics
	          if (post.post_number === 1) {
	            const path = window.location.pathname;
	            
	            const isDownloadPage = /^\/t\/webmethods-free-trial-download\//.test(path) || 
	                                 /^\/t\/adabas-and-natural-community-edition-download-form\//.test(path) ||
	                                 /^\/t\/webmethods-service-designer-download-form\//.test(path) ||
	                                 /^\/t\/webmethods-io-connector-builder-download-form\//.test(path) ||
	                                 /^\/t\/webmethods-service-designer-11-1-download-form\//.test(path);
	            
	            if (isDownloadPage) {
	              // Add our download form component before the reply button
	              // The position is roughly equivalent to the original "post-menu:before"
	              dag.add(
	                "download-form",
	                DownloadFormComponent,
	                { 
	                  before: buttonKeys.REPLY,
	                  attrs: {
	                    currentUser: api.getCurrentUser(),
	                    siteSettings: api.container.lookup('service:site-settings')
	                  }
	                }
	              );
	            }
	          }
	        }
	      );
	    });
	  }
	};
</script>
