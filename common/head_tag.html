<script type="text/javascript" nonce="{{nonce}}">

//Remove form spinner after form is loaded
function removeFormSpinner() {
    let spinner = document.querySelector('form.marketo-form .spinner-wrapper');
    if (spinner) {
        document.querySelector('form.marketo-form').removeChild(spinner);
    }
}

var profiling = {
    isEnabled: false,
    numberOfProfilingFields: 3,
    alwaysShowFields: ['mktDummyEntry']
};

var mktFormLanguage = 'English';

function checkNull(value) {
    if (typeof (value) != "undefined" && value != null && value != 'null') {
        return value;
    }
    return "";
}

/* Created new download_form widget which will display only if current URL contains  "/t/webmethods-free-trial/" */
api.createWidget("download_form", {
    tagName: "div.d-form",
    buildKey: () => "download_form",
    html(attrs) {
        let userFields = this.site.get("user_fields");
        let result = [];
        const path = window.location.pathname;

        if (true) {
            var currentuser = api.getCurrentUser();
            var currentusername;
            if (currentuser) {
                currentusername = currentuser.username;
            }
            if (currentusername && typeof currentusername !== 'undefined') {
                var fulllinktojson = "/users/" + currentusername + ".json";

                $.ajax({
                    type: 'GET',
                    url: fulllinktojson,
                    dataType: 'json',
                    success: function (json) {
                        let bannedCountries = ["Afghanistan", "Algeria", "Angola", "Armenia", "Azerbaijan", "Belarus", "Birma/Myanmar", "Burundi", "Cambodia", "Central African Republic", "China", "Congo", "Cyprus", "Democratic Rep. Of Congo", "Egypt", "Eritrea", "Ethiopia", "Georgia", "Guinea", "Guinea-Bissau", "Haiti", "Iraq", "Israel", "Jordan", "Kazakhstan", "Kyrgyzstan", "Laos", "Lebanon", "Libya", "Macau", "Mali", "Moldova", "Mongolia", "Mozambique", "Myanmar", "Nigeria", "Pakistan", "Russia", "Russian federation", "Somalia", "South Sudan", "Sri Lanka", "Tajikistan", "Tanzania", "Tunisia", "Turkmenistan", "Uganda", "Ukraine", "Uzbekistan", "Venezuela", "Vietnam", "Yemen", "Zimbabwe"];
                        const bannedEmailDomains = settings.banned_email_domains;

                        let isBelongsToBannedCountry = false;
                        let isBelongsToDownloadsGroup = false;
                        let isBelongsToBannedEmailDomain = false;

                        let countryFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("Country").toLowerCase());
                        let stateFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("State").toLowerCase());
                        let provinceFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("Province").toLowerCase());
                        let firstnameFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("First name").toLowerCase());
                        let lastnameFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("Last name").toLowerCase());
                        let companyFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("Company").toLowerCase());
                        let jobTitleFieldObj = userFields.find(obj => obj.name.toLowerCase() == ("Job Title").toLowerCase());

                        var currentuserEmail = String(json.user.email);
                        var currentuserFirstName = "";
                        if (firstnameFieldObj) { currentuserFirstName = checkNull(String(json.user.user_fields[firstnameFieldObj.id])); }
                        var currentuserLastName = ""
                        if (lastnameFieldObj) { currentuserLastName = checkNull(String(json.user.user_fields[lastnameFieldObj.id])); }
                        var currentuserJob = "";
                        if (jobTitleFieldObj) { currentuserJob = checkNull(String(json.user.user_fields[jobTitleFieldObj.id])); }
                        var currentuserCountry = "";
                        if (countryFieldObj) { currentuserCountry = checkNull(String(json.user.user_fields[countryFieldObj.id])); }
                        var currentuserCompany = "";
                        if (companyFieldObj) { currentuserCompany = checkNull(String(json.user.user_fields[companyFieldObj.id])); }
                        var currentuserState = "";
                        if (stateFieldObj) { currentuserState = checkNull(String(json.user.user_fields[stateFieldObj.id])); }
                        var currentuserProvince = "";
                        if (provinceFieldObj) { currentuserProvince = checkNull(String(json.user.user_fields[provinceFieldObj.id])); }

                        var currentuserGroups = [];
                        (json.user.groups).forEach(function (groupObj, index) {
                            currentuserGroups.push(String(groupObj.name).toLowerCase());
                        });

                        var lowerCaseBannedCountries = bannedCountries.map(function (value) {
                            return value.toLowerCase();
                        });

                        if (lowerCaseBannedCountries.indexOf(currentuserCountry.toLowerCase()) !== -1) {
                            isBelongsToBannedCountry = true;
                        }

                        if (bannedEmailDomains.length) {
                            var lowerCaseBannedEmailDomains = bannedEmailDomains.split("|").map(function (value) {
                                return value.toLowerCase();
                            });

                            var currentuserEmailDomain = currentuserEmail.substring(currentuserEmail.indexOf("@") + 1).toLowerCase();

                            if (lowerCaseBannedEmailDomains.indexOf(currentuserEmailDomain) !== -1) {
                                isBelongsToBannedEmailDomain = true;
                            }
                        }

                        if (currentuserGroups.indexOf(("Downloads").toLowerCase()) !== -1) {
                            isBelongsToDownloadsGroup = true;
                        }

                        if ((isBelongsToBannedCountry || isBelongsToBannedEmailDomain) && !isBelongsToDownloadsGroup) {
                            DiscourseURL.routeToUrl('/g/Downloads');
                        } else {
                            if (!window.MktoForms2) {
                                result.push(h('form.marketo-form.mktoForm.mktoHasWidth.mktoLayoutLeft', {
                                    "attributes": {
                                        "method": "post",
                                        "enctype": "application/x-www-form-urlencoded",
                                        "id": attrs.marketoFormId,
                                        "name": attrs.marketoFormId
                                    }
                                }, h('div.spinner-wrapper', { "attributes": { "style": "display:flex; justify-content:center; padding:0.5em" } }, h('span.spinner', ""))));

                            } else {
                                result.push(h('form.marketo-form.mktoForm.mktoHasWidth.mktoLayoutLeft', {
                                    "attributes": {
                                        "method": "post",
                                        "enctype": "application/x-www-form-urlencoded",
                                        "id": attrs.marketoFormId,
                                        "name": attrs.marketoFormId
                                    }
                                }));
                            }

                            try {
                                let state_province = "";
                                if (currentuserCountry && currentuserCountry.toUpperCase() == 'USA') {
                                    state_province = currentuserState;
                                } else if (currentuserCountry && currentuserCountry.toUpperCase() == 'CANADA') {
                                    state_province = currentuserProvince;
                                }

                                let autofillDownloadFormFields = function () {
                                    let firstNameInput = document.querySelector('input#FirstName')
                                    if (firstNameInput) {
                                        firstNameInput.value = currentuserFirstName;
                                    }
                                    let lastNameInput = document.querySelector('input#LastName');
                                    if (lastNameInput) {
                                        lastNameInput.value = currentuserLastName
                                    }
                                    let emailInput = document.querySelector('input#Email');
                                    if (emailInput) {
                                        emailInput.value = currentuserEmail;
                                    }
                                    let countryInput = document.querySelector('select#Address_Visit_Country__c');
                                    if (countryInput) {
                                        countryInput.value = currentuserCountry;
                                        countryInput.dispatchEvent(new Event('change'));
                                    }
                                    let StateProvinceInput = document.querySelector('select#Address_Visit_State__c');
                                    if (StateProvinceInput) {
                                        StateProvinceInput.value = state_province;
                                    }
                                    let companyInput = document.querySelector('input#Company');
                                    if (companyInput) {
                                        companyInput.value = currentuserCompany;
                                    }
                                    let jobTitleInput = document.querySelector('input#Title');
                                    if (jobTitleInput) {
                                        jobTitleInput.value = currentuserJob;
                                    }
                                }

                                switch (attrs.marketoFormId) {
                                    case "mktoForm_12281":
                                        if (!document.querySelector('form#mktoForm_12281')) {
                                            (function () {
                                                if (!window.MktoForms2) {
                                                    attrs.forms2MinJs.onload = function () {
                                                        var form = MktoForms2.loadForm("//info.softwareag.com", "858-DJP-749", 12281, autofillDownloadFormFields);
                                                        removeFormSpinner();
                                                    };
                                                } else {
                                                    var form = MktoForms2.loadForm("//info.softwareag.com", "858-DJP-749", 12281, autofillDownloadFormFields);
                                                    removeFormSpinner();
                                                }
                                            })();
                                        }
                                        break;

                                    case "mktoForm_12282":
                                        if (!document.querySelector('form#mktoForm_12282')) {
                                            (function () {
                                                if (!window.MktoForms2) {
                                                    attrs.forms2MinJs.onload = function () {
                                                        var form = MktoForms2.loadForm("//info.softwareag.com", "858-DJP-749", 12282, autofillDownloadFormFields);
                                                        removeFormSpinner();
                                                    };
                                                } else {
                                                    var form = MktoForms2.loadForm("//info.softwareag.com", "858-DJP-749", 12282, autofillDownloadFormFields);
                                                    removeFormSpinner();
                                                }

                                            })();
                                        }
                                        break;

                                    case "mktoForm_8655":
                                        if (!document.querySelector('form#mktoForm_8655')) {
                                            (function () {
                                                if (!window.MktoForms2) {
                                                    attrs.forms2MinJs.onload = function () {
                                                        var form = MktoForms2.loadForm("//info.softwareag.com", "858-DJP-749", 8655, autofillDownloadFormFields);
                                                        removeFormSpinner();
                                                    };
                                                } else {
                                                    var form = MktoForms2.loadForm("//info.softwareag.com", "858-DJP-749", 8655, autofillDownloadFormFields);
                                                    removeFormSpinner();
                                                }
                                            })();
                                        }
                                        break;

                                    case "mktoForm_12313":
                                        if (!document.querySelector('form#mktoForm_12313')) {
                                            (function () {
                                                if (!window.MktoForms2) {
                                                    attrs.forms2MinJs.onload = function () {
                                                        var form = MktoForms2.loadForm("//info.softwareag.com", "858-DJP-749", 12313, autofillDownloadFormFields);
                                                        removeFormSpinner();
                                                    };
                                                } else {
                                                    var form = MktoForms2.loadForm("//info.softwareag.com", "858-DJP-749", 12313, autofillDownloadFormFields);
                                                    removeFormSpinner();
                                                }
                                            })();
                                        }
                                        break;

                                    case "mktoForm_16841":
                                        if (!document.querySelector('form#mktoForm_16841')) {
                                            (function () {
                                                if (!window.MktoForms2) {
                                                    attrs.forms2MinJs.onload = function () {
                                                        var form = MktoForms2.loadForm("//info.softwareag.com", "858-DJP-749", 16841, autofillDownloadFormFields);
                                                        removeFormSpinner();
                                                    };
                                                } else {
                                                    var form = MktoForms2.loadForm("//info.softwareag.com", "858-DJP-749", 16841, autofillDownloadFormFields);
                                                    removeFormSpinner();
                                                }
                                            })();
                                        }
                                        break;

                                    default:
                                        break;
                                }

                            } catch (e) {
                                console.error(e);
                            } finally {
                                // Do nothing
                            }
                        }

                    },
                    async: false

                });
            }
            else {
                DiscourseURL.routeToUrl('/signup');
            }
        }
        return result;
    }
});

withPluginApi("1.34.0", (api) => {
    api.registerValueTransformer(
        "post-menu-buttons",
        ({
            value: dag,
            context: {
                post,
                firstButtonKey, // key of the first button
                secondLastHiddenButtonKey, // key of the second last hidden button
                lastHiddenButtonKey, // key of the last hidden button
            },
        }) => {
            const path = window.location.pathname;
            const forms2MinJsUrl = "https://info.softwareag.com/js/forms2/js/forms2.min.js";
            const munchkinJsUrl = "https://munchkin.marketo.net/munchkin.js";
            const mktFormSupportJsUrl = "https://info.softwareag.com/js/mktFormSupport.js";

            let marketoFormId = null;
            if (/^\/t\/webmethods-free-trial-download\//.test(path)) {
                marketoFormId = "mktoForm_12281";
            } else if (/^\/t\/adabas-and-natural-community-edition-download-form\//.test(path)) {
                marketoFormId = "mktoForm_12282";
            } else if (/^\/t\/webmethods-service-designer-download-form\//.test(path)) {
                marketoFormId = "mktoForm_8655";
            } else if (/^\/t\/webmethods-io-connector-builder-download-form\//.test(path)) {
                marketoFormId = "mktoForm_12313";
            } else if (/^\/t\/webmethods-service-designer-11-1-download-form\//.test(path)) {
                marketoFormId = "mktoForm_16841";
            } else {
                // Do nothing
            }

            if (marketoFormId) {
                let forms2MinJs = document.querySelector('head script[src="' + forms2MinJsUrl + '"]');

                if (!forms2MinJs) {
                    forms2MinJs = document.createElement("script");
                    let munchkinJs = document.createElement("script");
                    let mktFormSupportJs = document.createElement("script");

                    forms2MinJs.src = forms2MinJsUrl;
                    forms2MinJs.setAttribute("nonce", "");
                    document.head.appendChild(forms2MinJs);

                    munchkinJs.src = munchkinJsUrl;
                    munchkinJs.setAttribute("nonce", "");
                    document.head.appendChild(munchkinJs);

                    mktFormSupportJs.src = mktFormSupportJsUrl;
                    mktFormSupportJs.setAttribute("nonce", "");
                    document.head.appendChild(mktFormSupportJs);
                }

                const attrs = {
                    forms2MinJs: forms2MinJs,
                    marketoFormId: marketoFormId
                };

                dag.add(
                    "download-form",
                    DownloadFormButton,
                    {
                        before: [
                            "assign", // button added by the assign plugin
                            firstButtonKey,
                        ],
                    }
                );
            }
        }
    );
});
</script>
