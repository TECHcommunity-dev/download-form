<script type="text/javascript" nonce="{{nonce}}">
import Component from "@glimmer/component";
import { action } from "@ember/object";
import { inject as service } from "@ember/service";
import DButton from "discourse/components/d-button";
import { ajax } from "discourse/lib/ajax";
import { popupAjaxError } from "discourse/lib/ajax-error";

export default class DownloadFormButton extends Component {
  // indicates if the button will be promptly displayed or hidden behind the show more button
  static hidden(args) { 
    return !args.post.firstPost;
  }

  @action
  showDownloadForm() {
    // Your logic to show the download form
  }

  <template>
    <DButton
      class="post-action-menu__download-form"
      ...attributes
      @action={{this.showDownloadForm}}
      @icon="download"
      @label="Download Form"
      @title="Show Download Form"
    />
  </template>
}

// Register the value transformer
withPluginApi("1.34.0", (api) => {
  api.registerValueTransformer(
    "post-menu-buttons",
    ({
      value: dag, 
      context: {
        post,
        firstButtonKey, // key of the first button
        secondLastHiddenButtonKey, // key of the second last hidden button
        lastHiddenButtonKey, // key of the last hidden button
      },
    }) => {
        dag.add(
          "download-form",
          DownloadFormButton,
          post.firstPost
            ? {
                before: lastHiddenButtonKey,
                after: secondLastHiddenButtonKey,
              }
            : {
                before: [
                  "assign", // button added by the assign plugin
                  firstButtonKey,
                ],
              }
        );
    }
  );
});
</script>
